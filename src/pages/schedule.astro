---
import Layout from '../layouts/Layout.astro';
import '../styles/global.css';
---

<Layout>
  <main class="bg-neutral-900 min-h-screen flex flex-col items-center py-10 px-4 font-sans">
    <div class="mx-auto max-w-screen-md px-4 pb-20 pt-[140px]">
      <h1 class="text-foreground mb-16 text-center text-4xl font-extrabold md:text-7xl">Schedule a Meeting</h1>
      <p class="mb-8 text-center font-light sm:text-xl lg:mb-16">
        Ready to talk about your project or ongoing needs? Pick a date and time below and we'll be in touch to confirm your meeting.
      </p>
      <div id="form-container">
        <div id="success-message" class="hidden rounded-lg border border-green-300 bg-green-50 p-6 text-center dark:border-green-700 dark:bg-green-900/20">
          <h3 class="text-2xl font-semibold text-green-800 dark:text-green-200">Thank you!</h3>
          <p class="mt-2 text-green-700 dark:text-green-300">
            Your meeting has been scheduled. We'll get back to you shortly.
          </p>
        </div>
        <form id="schedule-form" class="space-y-8">
          <div>
            <label for="name" class="mb-2 block text-sm font-medium text-stone-900 dark:text-stone-300">Your name</label>
            <input type="text" id="name" name="name" required class="focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-500 dark:focus:border-primary-500 dark:shadow-sm-light block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 shadow-sm dark:border-stone-600 dark:bg-stone-700 dark:text-stone-100 dark:placeholder-stone-400" placeholder="Jane Doe" />
          </div>
          <div>
            <label for="email" class="mb-2 block text-sm font-medium text-stone-900 dark:text-stone-300">Your email</label>
            <input type="email" id="email" name="email" required class="focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-500 dark:focus:border-primary-500 dark:shadow-sm-light block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 shadow-sm dark:border-stone-600 dark:bg-stone-700 dark:text-stone-100 dark:placeholder-stone-400" placeholder="you@example.com" />
          </div>
          <div>
            <label for="date" class="mb-2 block text-sm font-medium text-stone-900 dark:text-stone-300">Select a Date</label>
            <input type="date" id="date" name="date" required class="focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-500 dark:focus:border-primary-500 dark:shadow-sm-light block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 shadow-sm dark:border-stone-600 dark:bg-stone-700 dark:text-stone-100 dark:placeholder-stone-400" />
            <div id="calendar-iframe-container" class="my-6 w-full max-w-2xl mx-auto hidden">
              <h2 class="text-xl font-bold text-center mb-2 text-teal-200">View My Availability</h2>
              <iframe src="https://calendar.google.com/calendar/embed?src=jeremy.grice%40snowdoniastudio.com&ctz=America%2FNew_York" style="border:0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
              <!-- Replace the src URL above with your actual Google Calendar embed link -->
            </div>
          </div>
          <div>
            <label for="time" class="mb-2 block text-sm font-medium text-stone-900 dark:text-stone-300">Select a Time</label>
            <input type="time" id="time" name="time" required class="focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-500 dark:focus:border-primary-500 dark:shadow-sm-light block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 shadow-sm dark:border-stone-600 dark:bg-stone-700 dark:text-stone-100 dark:placeholder-stone-400" />
          </div>
          <div id="error-message" class="hidden text-center text-sm text-red-600 dark:text-red-400"></div>
          <div class="text-center">
            <button id="submit-button" type="submit" class="rounded-lg bg-primary-600 px-8 py-3 text-white transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-stone-700 dark:hover:bg-stone-600">
              <span id="submit-text">Schedule Meeting</span>
              <span id="submit-loading" class="hidden">Schedulingâ€¦</span>
            </button>
          </div>
        </form>
        <div class="my-6 w-full max-w-2xl mx-auto text-center">
          <a
            href="https://calendar.app.google/zGK1M4KPc2YS9Z5w8"
            target="_blank"
            rel="noopener"
            class="inline-block bg-teal-200 text-black font-bold py-3 px-6 rounded-lg shadow hover:bg-teal-100 transition"
          >
            Book a Time on My Calendar
          </a>
          <p class="mt-2 text-sm text-neutral-400">This will open my Google booking page in a new tab.</p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // @ts-nocheck
  const form = document.getElementById('schedule-form');
  const submitButton = document.getElementById('submit-button');
  const submitText = document.getElementById('submit-text');
  const submitLoading = document.getElementById('submit-loading');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  // Read calculator selections from URL params
  const urlParams = new URLSearchParams(window.location.search);
  const calcSelections = {
    siteType: urlParams.get('siteType') || '',
    features: urlParams.get('features') || '',
    packs: urlParams.get('packs') || '',
    pages: urlParams.get('pages') || ''
  };

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset UI state
      errorMessage.classList.add('hidden');
      submitButton.disabled = true;
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');

      const formData = new FormData(form);

      // Add required fields for /api/contact
      formData.set('subject', 'Meeting Request');
      const name = formData.get('name') || '';
      const date = formData.get('date') || '';
      const time = formData.get('time') || '';
      // Compose message with calculator selections
      let message = `Meeting request from ${name}\nDate: ${date}\nTime: ${time}`;
      
      if (calcSelections.siteType || calcSelections.features || calcSelections.packs || calcSelections.pages) {
        message += `\n\n--- Calculator Selections ---`;
        if (calcSelections.siteType) message += `\nSite Type: ${calcSelections.siteType}`;
        if (calcSelections.features) message += `\nFeatures: ${calcSelections.features}`;
        if (calcSelections.packs) message += `\nPacks: ${calcSelections.packs}`;
        if (calcSelections.pages) message += `\nPages: ${calcSelections.pages}`;
      }
      formData.set('message', message);

      try {
        const res = await fetch('/api/contact', {
          method: 'POST',
          body: formData,
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          throw new Error(data?.error || 'Failed to schedule meeting');
        }

        // Success - show success message and hide form
        form.style.display = 'none';
        successMessage.classList.remove('hidden');

        // Update URL hash
        if (typeof window !== 'undefined') {
          try {
            const url = new URL(window.location.href);
            url.hash = 'thank-you';
            window.history.replaceState(null, '', url.toString());
          } catch {
            window.location.hash = 'thank-you';
          }
        }

        // Reset form
        form.reset();
      } catch (err) {
        // Show error message
        errorMessage.textContent = err?.message || 'Something went wrong. Please try again.';
        errorMessage.classList.remove('hidden');
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    });
  }

  // Show/hide calendar iframe below date field
  const dateInput = document.getElementById('date');
  const calendarIframeContainer = document.getElementById('calendar-iframe-container');
  if (dateInput && calendarIframeContainer) {
    dateInput.addEventListener('focus', () => {
      calendarIframeContainer.classList.remove('hidden');
    });
    // Optional: hide iframe when date input loses focus
    dateInput.addEventListener('blur', () => {
      setTimeout(() => calendarIframeContainer.classList.add('hidden'), 200); // delay to allow interaction
    });
  }
</script>

<style>
  .text-foreground {
    color: inherit;
  }
  @media (prefers-color-scheme: dark) {
    .text-foreground {
      color: #f9fafb;
    }
  }
</style>