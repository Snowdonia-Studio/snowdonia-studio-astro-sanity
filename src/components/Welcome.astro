---
import { loadQuery } from '../sanity/lib/load-query';
import { urlForImage } from '../sanity/lib/url-for-image';
import Services from './Services.astro';
import type { HomepageSection, HomepageData } from '../interfaces/Homepage.ts';
import type { Post } from '../interfaces/Post.ts';
import TEXT from '../constants.js';

const postsQuery = await loadQuery<Post[]>({
  query: `*[_type == "post"]|order(publishedAt desc){
    _id,
    author->{
      _id,
      name,
      image
    },
    title,
    slug,
    publishedAt,
    mainImage,
    body
  }`
});

const homepageQuery = await loadQuery<HomepageData>({
  query: `*[_type == "homepage"][0]{
    title,
    subtitle,
    description,
    heroImage,
    ctaText,
    ctaLink,
    sections
  }`
});

const posts = postsQuery.data.result;
const homepage = homepageQuery.data.result;
---

<div id="container">
  {
    homepage?.heroImage?.asset._ref && (
      <img
        src={urlForImage({ asset: { _ref: homepage?.heroImage?.asset._ref } }).url()}
        alt="Background"
        class="mx-auto max-w-screen-2xl border-t px-4 py-8"
      />
    )
  }
  <main>
    <section id="hero" class="mx-auto max-w-screen-2xl border-t px-4 py-8">
      <h1 class="text-3xl text-teal-200 font-bold">
        {homepage?.title}
      </h1>
      {homepage?.subtitle && <h2 class="text-xl text-white mt-2">{homepage?.subtitle}</h2>}
      {homepage?.description && <p class="text-lg text-white mt-4 max-w-2xl">{homepage?.description}</p>}
      <section id="links">
        <a class="button" href={homepage?.ctaLink}>{homepage?.ctaText}</a>
      </section>
    </section>
  </main>

  {homepage?.sections && homepage.sections.length > 0 && (
    <div id="sections" class="sections-container">
      {homepage.sections.map((section: HomepageSection) => (
        <div class="section-box">
          {section.image && (
            <img
              src={urlForImage(section.image).width(600).height(400).url()}
              alt={section.image.alt || section.title || 'Section image'}
              class="section-image"
            />
          )}
          {section.title && <h2>{section.title}</h2>}
          {section.content && <p>{section.content}</p>}
        </div>
      ))}
    </div>
  )}

  <section class="mx-auto max-w-screen-2xl border-t px-4 py-8">
    <h2 class="text-2xl font-semibold mb-4">{TEXT['OUR_THOUGHTS']}</h2>
    {posts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {posts.map((post) => (
          <div class="w-full rounded overflow-hidden shadow-lg mx-2">
            <img class="w-full h-auto" src={post.mainImage ? urlForImage(post.mainImage).url() : ''} alt={post.title} />

            <div class="px-6 py-4">
              <div class="font-bold text-xl mb-2">{post.title}</div>
              <p class="text-white text-base">
                {post.body?.[0]?.children?.[0]?.text || 'No description available.'}
              </p>
              <button class="mt-4 bg-teal-200 text-white font-bold py-2 px-4 rounded">
                <a href={`/post/${post.slug.current}`}>{TEXT['READ_ARTICLE']}</a>
              </button>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p>No posts found.</p>
    )}
  </section>
<Services />

<style>
  #background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    filter: blur(100px);
    object-fit: cover;
  }

  #container {
    font-family: Inter, Roboto, 'Helvetica Neue', 'Arial Nova', 'Nimbus Sans', Arial, sans-serif;
    min-height: 100vh;
    padding: 2rem 1rem;
  }

  main {
    min-height: calc(100vh - 200px);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  * {
    color: '#000000 !important'
  }
</style>
