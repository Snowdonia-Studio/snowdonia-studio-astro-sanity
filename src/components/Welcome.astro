---
import { loadQuery } from '../sanity/lib/load-query';
import { urlForImage } from '../sanity/lib/url-for-image';
import Services from './Services.astro';
import type { HomepageSection, HomepageData } from '../interfaces/Homepage.ts';
import type { Post } from '../interfaces/Post.ts';

const postsQuery = await loadQuery<Post[]>({
  query: `*[_type == "post"]|order(publishedAt desc){
    _id,
    author->{
      _id,
      name,
      image
    },
    title,
    slug,
    publishedAt,
    mainImage,
    body
  }`
});

const homepageQuery = await loadQuery<HomepageData>({
  query: `*[_type == "homepage"][0]{
    title,
    subtitle,
    description,
    heroImage,
    ctaText,
    ctaLink,
    sections
  }`
});

const posts = postsQuery.data.result;
const homepage = homepageQuery.data.result;
---

<div id="container">
  {
    homepage?.heroImage?.asset._ref && (
      <img
        src={urlForImage({ asset: { _ref: homepage?.heroImage?.asset._ref } }).url()}
        alt="Background"
      />
    )
  }
  <main>
    <section id="hero">
      <h1 class="text-3xl text-black font-bold">
        {homepage?.title}
      </h1>
      {homepage?.subtitle && <h2 class="text-xl text-gray-600 dark:text-gray-400 mt-2">{homepage?.subtitle}</h2>}
      {homepage?.description && <p class="text-lg mt-4 max-w-2xl">{homepage?.description}</p>}
      <section id="links">
        <a class="button" href={homepage?.ctaLink}>{homepage?.ctaText}</a>
      </section>
    </section>
  </main>

  {homepage?.sections && homepage.sections.length > 0 && (
    <div id="sections" class="sections-container">
      {homepage.sections.map((section: HomepageSection) => (
        <div class="section-box">
          {section.image && (
            <img
              src={urlForImage(section.image).width(600).height(400).url()}
              alt={section.image.alt || section.title || 'Section image'}
              class="section-image"
            />
          )}
          {section.title && <h2>{section.title}</h2>}
          {section.content && <p>{section.content}</p>}
        </div>
      ))}
    </div>
  )}

  <section>
    <h2>All Posts</h2>
    {posts.length > 0 ? (
      <ul>
        {posts.map((post) => (
          <li>
            <a href={`/post/${post.slug.current}`}>
              {post.title}
            </a>
            {post.author?.name && (
              <span> &mdash; {post.author.name}</span>
            )}
          </li>
        ))}
      </ul>
    ) : (
      <p>No posts found.</p>
    )}
  </section>
<Services />

<style>
  #background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    filter: blur(100px);
    object-fit: cover;
  }

  #container {
    font-family: Inter, Roboto, 'Helvetica Neue', 'Arial Nova', 'Nimbus Sans', Arial, sans-serif;
    min-height: 100vh;
    padding: 2rem 1rem;
  }

  main {
    min-height: calc(100vh - 200px);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  * {
    color: '#000000 !important'
  }
</style>
