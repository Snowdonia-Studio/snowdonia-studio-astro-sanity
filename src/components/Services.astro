---
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../sanity/lib/load-query';
import { urlForImage } from '../sanity/lib/url-for-image';

interface ServiceData extends SanityDocument {
  title?: string;
  description?: string;
  icon?: {
    asset: {
      _ref: string;
      _type: string;
    };
    alt?: string;
  };
  order?: number;
}

// Fetch services from Sanity
const result = await loadQuery<ServiceData[]>({
  query: `*[_type == "service"] | order(order asc) {
    title,
    description,
    icon,
    order
  }`,
});

// Ensure services is always an array
const servicesData = result.data as any;
const services = Array.isArray(servicesData) ? servicesData : [];
---

<section id="services" class="services-section">
  <div class="services-container">
    {
      services.map((service, index) => (
        <div class="service-item" data-index={index}>
          {service.icon && (
            <div class="service-icon">
              <img
                src={urlForImage(service.icon).width(80).height(80).url()}
                alt={service.icon.alt || service.title || 'Service icon'}
              />
            </div>
          )}
          <h3 class="service-title">{service.title}</h3>
          {service.description && <p class="service-description">{service.description}</p>}
        </div>
      ))
    }
  </div>
</section>

<script>
  // @ts-nocheck
  async function initServicesAnimation() {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initServicesAnimation);
      return;
    }

    // Dynamically import GSAP to ensure it's available
    const { default: gsap } = await import('gsap');
    const { ScrollTrigger } = await import('gsap/ScrollTrigger');

    gsap.registerPlugin(ScrollTrigger);

    const serviceItems = document.querySelectorAll('.service-item');

    if (serviceItems.length === 0) return;

    // Create a timeline for staggered animations
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: '.services-section',
        start: 'top 80%',
        end: 'bottom 20%',
        toggleActions: 'play none none reverse',
      },
    });

    // Animate each service item with stagger
    serviceItems.forEach((item, index) => {
      gsap.set(item, {
        opacity: 0,
        y: 60,
        scale: 0.9,
      });

      tl.to(
        item,
        {
          opacity: 1,
          y: 0,
          scale: 1,
          duration: 0.8,
          ease: 'power3.out',
        },
        index * 0.1 // Stagger delay
      );
    });

    // Add hover animations
    serviceItems.forEach((item) => {
      item.addEventListener('mouseenter', () => {
        gsap.to(item, {
          scale: 1.05,
          y: -10,
          duration: 0.3,
          ease: 'power2.out',
        });
      });

      item.addEventListener('mouseleave', () => {
        gsap.to(item, {
          scale: 1,
          y: 0,
          duration: 0.3,
          ease: 'power2.out',
        });
      });
    });
  }

  // Initialize when DOM is ready
  initServicesAnimation();
</script>

<style>
  .services-section {
    padding: 80px 20px;
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
  }

  .services-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    padding: 2rem 0;
  }

  .service-item {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 16px;
    padding: 2.5rem;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.3s ease;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }

  .service-item:hover {
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
  }

  .service-icon {
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .service-icon img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
  }

  .service-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #111827;
  }

  .service-description {
    font-size: 1rem;
    line-height: 1.6;
    color: #4b5563;
    margin: 0;
  }

  @media (prefers-color-scheme: dark) {
    .service-item {
      background: rgba(31, 41, 55, 0.9);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .service-title {
      color: #f9fafb;
    }

    .service-description {
      color: #9ca3af;
    }
  }

  @media screen and (max-width: 768px) {
    .services-section {
      padding: 60px 16px;
    }

    .services-container {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .service-item {
      padding: 2rem;
    }

    .service-title {
      font-size: 1.25rem;
    }
  }
</style>
